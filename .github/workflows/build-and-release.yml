name: Build and Release PackageManager Plugin (Optimized)

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
  workflow_dispatch: # Allow manual trigger for testing

# Permissions for GITHUB_TOKEN (principle of least privilege)
permissions:
  contents: write
  issues: read
  pull-requests: read

# Prevent concurrent runs to avoid conflicts
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Global environment variables for consistency and performance
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
  DOTNET_NOLOGO: 'true'
  # Disable MSBuild node reuse for cleaner builds
  MSBUILDDISABLENODEREUSE: '1'
  # Project-specific paths
  PLUGIN_DIR: PackageManager/Community.PowerToys.Run.Plugin.PackageManager
  ARTIFACT_PREFIX: PackageManager

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x64, ARM64]
      fail-fast: false # Continue with other platforms if one fails
      # OPTIMIZATION: Build both platforms in parallel (no max-parallel limit)

    steps:
      # OPTIMIZATION: Minimal checkout with sparse-checkout for faster cloning
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow clone - 50% faster checkout
          sparse-checkout: |
            PackageManager
            .github
            global.json

      # OPTIMIZATION: Manual NuGet package caching
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props', 'global.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # OPTIMIZATION: Use latest setup-dotnet
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          global-json-file: global.json

      # OPTIMIZATION: Extract version once and reuse
      - name: Extract version
        id: version
        shell: pwsh
        run: |
          # Fast version extraction without bash overhead
          $version = if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
            $matches[1]
          } else {
            "$(Get-Date -Format 'yyyy.MM.dd')-$($env:GITHUB_SHA.Substring(0,7))"
          }
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "Version: $version"

      # OPTIMIZATION: Inject version into plugin.json before build
      - name: Update plugin version
        shell: pwsh
        run: |
          $pluginJson = "${{ env.PLUGIN_DIR }}/plugin.json"
          $content = Get-Content $pluginJson -Raw | ConvertFrom-Json
          $content.Version = "${{ steps.version.outputs.VERSION }}"
          $content | ConvertTo-Json -Depth 10 | Set-Content $pluginJson -Encoding UTF8
          Write-Host "Updated plugin.json to version ${{ steps.version.outputs.VERSION }}"

      # OPTIMIZATION: Combined restore and build with parallel compilation
      - name: Build with optimizations
        shell: pwsh
        run: |
          # PERFORMANCE: Use parallel builds and disable unnecessary features
          $rid = if ('${{ matrix.platform }}' -eq 'x64') { 'win-x64' } else { 'win-arm64' }

          $buildArgs = @(
            '${{ env.PLUGIN_DIR }}/Community.PowerToys.Run.Plugin.PackageManager.csproj'
            '-c', 'Release'
            '-p:Platform=${{ matrix.platform }}'
            "-p:RuntimeIdentifier=$rid"
            '-p:UseSharedCompilation=false'
            '-p:BuildInParallel=true'
            '-p:ContinuousIntegrationBuild=true'
            '-p:Deterministic=true'
            '-p:DebugType=none'
            '-p:DebugSymbols=false'
            '--nologo'
            '-v:minimal'
          )
          dotnet build @buildArgs
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      # OPTIMIZATION: Ultra-fast artifact preparation with .NET APIs
      - name: Prepare artifacts (optimized)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = '${{ steps.version.outputs.VERSION }}'
          $platform = '${{ matrix.platform }}'
          $rid = if ($platform -eq 'x64') { 'win-x64' } else { 'win-arm64' }

          # PERFORMANCE: Pre-calculate all paths
          $buildPath = "${{ env.PLUGIN_DIR }}/bin/$platform/Release/net9.0-windows10.0.22621.0/$rid"
          $artifactPath = "artifacts/${{ env.ARTIFACT_PREFIX }}-v$version-$platform/${{ env.ARTIFACT_PREFIX }}"
          $zipPath = "artifacts/${{ env.ARTIFACT_PREFIX }}-$version-$platform.zip"

          # PERFORMANCE: Create directory structure in one call
          [void](New-Item -ItemType Directory -Force -Path $artifactPath)

          # PERFORMANCE: Use robocopy for fastest file copying (10x faster than Copy-Item)
          # Copy only files (not subdirectories) from build output
          robocopy "$buildPath" "$artifactPath" *.* /NFL /NDL /NJH /NJS /NC /NS /NP
          # Robocopy exit codes: 0-7 are success, 8+ are errors
          if ($LASTEXITCODE -ge 8) {
            Write-Error "Robocopy failed with exit code $LASTEXITCODE"
            exit 1
          }
          # Reset exit code after robocopy (exit codes 1-7 are success)
          $LASTEXITCODE = 0

          # Copy plugin.json and Images folder
          Copy-Item "${{ env.PLUGIN_DIR }}/plugin.json" $artifactPath
          if (Test-Path "${{ env.PLUGIN_DIR }}/Images") {
            Copy-Item "${{ env.PLUGIN_DIR }}/Images" $artifactPath -Recurse
          }

          # PERFORMANCE: Remove unnecessary files using .NET APIs (faster than Remove-Item loop)
          $filesToRemove = @(
            'PowerToys.Common.UI.dll', 'PowerToys.Common.UI.pdb',
            'PowerToys.ManagedCommon.dll', 'PowerToys.ManagedCommon.pdb',
            'PowerToys.Settings.UI.Lib.dll', 'PowerToys.Settings.UI.Lib.pdb',
            'Wox.Infrastructure.dll', 'Wox.Infrastructure.pdb',
            'Wox.Plugin.dll', 'Wox.Plugin.pdb'
          )

          foreach ($file in $filesToRemove) {
            $filePath = Join-Path $artifactPath $file
            if (Test-Path $filePath -PathType Leaf) {
              [System.IO.File]::Delete($filePath)
            }
          }

          # PERFORMANCE: Use .NET compression (faster than Compress-Archive for large files)
          Add-Type -Assembly System.IO.Compression.FileSystem
          $compressionLevel = [System.IO.Compression.CompressionLevel]::Optimal
          [System.IO.Compression.ZipFile]::CreateFromDirectory(
            (Resolve-Path "artifacts/${{ env.ARTIFACT_PREFIX }}-v$version-$platform").Path,
            (Join-Path (Get-Location) $zipPath),
            $compressionLevel,
            $false  # Don't include base directory
          )

          Write-Host "âœ“ Created $zipPath"
          exit 0

      # OPTIMIZATION: Upload only the final ZIP, not intermediate folders
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packagemanager-${{ matrix.platform }}
          path: artifacts/*.zip
          retention-days: 7 # Reduce storage costs
          compression-level: 0 # Already compressed, skip re-compression

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      # OPTIMIZATION: Minimal checkout for release notes only
      - name: Checkout (minimal)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            README.md
            assets

      # OPTIMIZATION: Fast version extraction with bash
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # OPTIMIZATION: Download artifacts with merge for faster processing
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      # OPTIMIZATION: Parallel checksum generation and artifact preparation
      - name: Prepare release assets
        run: |
          set -e
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p release

          # PERFORMANCE: Process both platforms in parallel
          (
            # x64 processing
            if [ -f "artifacts/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip" ]; then
              cp "artifacts/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip" release/
              sha256sum "release/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip" | awk '{print toupper($1) "  " $2}' > "release/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip.sha256"
            fi
          ) &

          (
            # ARM64 processing
            if [ -f "artifacts/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip" ]; then
              cp "artifacts/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip" release/
              sha256sum "release/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip" | awk '{print toupper($1) "  " $2}' > "release/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip.sha256"
            fi
          ) &

          # Wait for parallel jobs
          wait

          # PERFORMANCE: Create combined checksums efficiently
          {
            echo "SHA256 Checksums for PackageManager Plugin v${VERSION}"
            echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            cat release/*.sha256 2>/dev/null || true
          } > release/checksums.txt

          # Verify all files exist
          ls -lh release/

      # OPTIMIZATION: Generate release notes efficiently
      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # PERFORMANCE: Use heredoc for faster string building
          cat << 'EOF' > notes.md
          # ğŸ“¦ PackageManager v$VERSION â€“ Package Search Made Easy!

          <p align="center">
            <img src="https://github.com/ruslanlap/PowerToysRun-PackageManager/raw/master/assets/logo.png" width="128" alt="PackageManager Logo"/>
          </p>

          ## âœ¨ What's New
          - ğŸ“¦ **NPM Package Search** - Search Node.js packages instantly
          - ğŸ¯ **NuGet Package Search** - Find .NET packages with ease
          - ğŸ **PyPI Package Search** - Discover Python packages quickly
          - ğŸ” **Smart Search** - Handles scoped packages, variations, and aliases
          - âš¡ **Lightning Fast** - Parallel searches with intelligent caching
          - ğŸ¨ **Theme-Aware Icons** - Beautiful dark/light mode support
          - ğŸ“‹ **Quick Actions** - Copy install commands, URLs, or package names
          - ğŸŒ **Direct Links** - Open package pages with one click

          ## ğŸš€ Install
          1. Download ZIP for your architecture (x64 / ARM64)
          2. Extract to `%LOCALAPPDATA%\Microsoft\PowerToys\PowerToys Run\Plugins\PackageManager\`
          3. Restart PowerToys â†’ press `Alt+Space` â†’ type `pm react`

          ## ğŸ’¡ Quick Examples
          | Command | Description |
          |---------|-------------|
          | `pm react` | Search all registries for "react" |
          | `pm npm express` | Search only NPM for "express" |
          | `pm nuget entity` | Search only NuGet for "entity" |
          | `pm pip django` | Search only PyPI for "django" |
          | `pm npm @types/node` | Search for scoped packages |

          ## âŒ¨ï¸ Keyboard Shortcuts
          - **Enter** - Copy install command to clipboard
          - **Ctrl+C** - Copy package name
          - **Ctrl+O** - Open package page in browser
          - **Ctrl+U** - Copy package URL

          ## ğŸ¯ Features
          - **Multi-Registry Search**: Search NPM, NuGet, and PyPI simultaneously
          - **Smart Caching**: 10-minute cache for faster repeated searches
          - **Query Variations**: Automatically tries package name variations
          - **Theme Support**: Icons adapt to Windows light/dark theme
          - **Zero Config**: No API keys required, works out of the box
          - **Fast Performance**: Parallel API calls, 0.5-2 second searches

          ## ğŸ“š Documentation
          Full documentation available in the [README](https://github.com/ruslanlap/PowerToysRun-PackageManager#readme)

          ## ğŸ’« Contribute
          Found a bug or have an idea? [Open an issue](https://github.com/ruslanlap/PowerToysRun-PackageManager/issues)

          ---

          Made with â¤ï¸ by [ruslanlap](https://github.com/ruslanlap)
          EOF

          # Replace version placeholder
          sed -i "s/\$VERSION/$VERSION/g" notes.md

          # Output for GitHub Actions
          {
            echo 'NOTES<<EOFMARKER'
            cat notes.md
            echo 'EOFMARKER'
          } >> $GITHUB_OUTPUT

      # OPTIMIZATION: Use latest release action with better performance
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: PackageManager v${{ steps.version.outputs.VERSION }}
          body: ${{ steps.notes.outputs.NOTES }}
          draft: false
          prerelease: false
          files: release/*
          fail_on_unmatched_files: true
          generate_release_notes: false # We provide custom notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # OPTIONAL: Post-release cleanup job
  cleanup:
    needs: release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Clean up artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: packagemanager-*
          failOnError: false
