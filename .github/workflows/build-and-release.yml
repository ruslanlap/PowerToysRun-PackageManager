name: Build and Release PackageManager Plugin

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  issues: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
  DOTNET_NOLOGO: 'true'
  MSBUILDDISABLENODEREUSE: '1'
  PLUGIN_DIR: PackageManager/Community.PowerToys.Run.Plugin.PackageManager
  ARTIFACT_PREFIX: PackageManager

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x64, ARM64]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            PackageManager
            .github
            global.json

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props', 'global.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          global-json-file: global.json

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $version = if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
            $matches[1]
          } else {
            "$(Get-Date -Format 'yyyy.MM.dd')-$($env:GITHUB_SHA.Substring(0,7))"
          }
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "Version: $version"

      - name: Update plugin version
        shell: pwsh
        run: |
          $pluginJson = "${{ env.PLUGIN_DIR }}/plugin.json"
          $content = Get-Content $pluginJson -Raw | ConvertFrom-Json
          $content.Version = "${{ steps.version.outputs.VERSION }}"
          $content | ConvertTo-Json -Depth 10 | Set-Content $pluginJson -Encoding UTF8
          Write-Host "Updated plugin.json to version ${{ steps.version.outputs.VERSION }}"

      - name: Publish plugin for Windows
        shell: pwsh
        run: |
          $rid = if ('${{ matrix.platform }}' -eq 'x64') { 'win-x64' } else { 'win-arm64' }

          Write-Host "Publishing for $rid..."
          dotnet publish `
            "${{ env.PLUGIN_DIR }}/Community.PowerToys.Run.Plugin.PackageManager.csproj" `
            -c Release `
            -r $rid `
            -p:Platform=${{ matrix.platform }} `
            -p:PublishSingleFile=false `
            -p:SelfContained=false `
            --nologo `
            -v:minimal

          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Prepare artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = '${{ steps.version.outputs.VERSION }}'
          $platform = '${{ matrix.platform }}'
          $rid = if ($platform -eq 'x64') { 'win-x64' } else { 'win-arm64' }

          # Paths
          $publishPath = "${{ env.PLUGIN_DIR }}/bin/$platform/Release/net9.0-windows10.0.22621.0/$rid/publish"
          $stagePath = "artifacts/${{ env.ARTIFACT_PREFIX }}-v$version-$platform/${{ env.ARTIFACT_PREFIX }}"
          $zipPath = "artifacts/${{ env.ARTIFACT_PREFIX }}-$version-$platform.zip"

          # Create staging directory
          [void](New-Item -ItemType Directory -Force -Path $stagePath)

          # Copy all published files
          Copy-Item "$publishPath\*" $stagePath -Recurse -Force

          # Remove PowerToys/Wox dependencies (they're provided by PowerToys)
          $excludePatterns = @('PowerToys*.dll', 'PowerToys*.pdb', 'Wox*.dll', 'Wox*.pdb')
          foreach ($pattern in $excludePatterns) {
            Get-ChildItem $stagePath -Filter $pattern -Recurse | Remove-Item -Force
          }

          # Copy plugin.json and Images
          Copy-Item "${{ env.PLUGIN_DIR }}/plugin.json" $stagePath -Force
          if (Test-Path "${{ env.PLUGIN_DIR }}/Images") {
            Copy-Item "${{ env.PLUGIN_DIR }}/Images" $stagePath -Recurse -Force
          }

          # Create ZIP
          Add-Type -Assembly System.IO.Compression.FileSystem
          $compressionLevel = [System.IO.Compression.CompressionLevel]::Optimal
          [System.IO.Compression.ZipFile]::CreateFromDirectory(
            (Resolve-Path "artifacts/${{ env.ARTIFACT_PREFIX }}-v$version-$platform").Path,
            (Join-Path (Get-Location) $zipPath),
            $compressionLevel,
            $false
          )

          Write-Host "âœ“ Created $zipPath"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packagemanager-${{ matrix.platform }}
          path: artifacts/*.zip
          retention-days: 7
          compression-level: 0

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout (minimal)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            README.md
            assets

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Prepare release assets
        run: |
          set -e
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p release

          # Process both platforms in parallel
          (
            if [ -f "artifacts/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip" ]; then
              cp "artifacts/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip" release/
              sha256sum "release/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip" | awk '{print toupper($1) "  " $2}' > "release/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip.sha256"
            fi
          ) &

          (
            if [ -f "artifacts/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip" ]; then
              cp "artifacts/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip" release/
              sha256sum "release/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip" | awk '{print toupper($1) "  " $2}' > "release/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip.sha256"
            fi
          ) &

          wait

          {
            echo "SHA256 Checksums for PackageManager Plugin v${VERSION}"
            echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            cat release/*.sha256 2>/dev/null || true
          } > release/checksums.txt

          ls -lh release/

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          cat << 'EOF' > notes.md
          # ğŸ“¦ PackageManager v$VERSION â€“ Package Search Made Easy!

          <p align="center">
            <img src="https://github.com/ruslanlap/PowerToysRun-PackageManager/raw/master/assets/logo.png" width="128" alt="PackageManager Logo"/>
          </p>

          ## âœ¨ What's New
          - ğŸ“¦ **NPM Package Search** - Search Node.js packages instantly
          - ğŸ¯ **NuGet Package Search** - Find .NET packages with ease
          - ğŸ **PyPI Package Search** - Discover Python packages quickly
          - ğŸ” **Smart Search** - Handles scoped packages, variations, and aliases
          - âš¡ **Lightning Fast** - Parallel searches with intelligent caching
          - ğŸ¨ **Theme-Aware Icons** - Beautiful dark/light mode support
          - ğŸ“‹ **Quick Actions** - Copy install commands, URLs, or package names
          - ğŸŒ **Direct Links** - Open package pages with one click

          ## ğŸš€ Install
          1. Download ZIP for your architecture (x64 / ARM64)
          2. Extract to `%LOCALAPPDATA%\Microsoft\PowerToys\PowerToys Run\Plugins\PackageManager\`
          3. Restart PowerToys â†’ press `Alt+Space` â†’ type `pm react`

          ## ğŸ’¡ Quick Examples
          | Command | Description |
          |---------|-------------|
          | `pm react` | Search all registries for "react" |
          | `pm npm express` | Search only NPM for "express" |
          | `pm nuget entity` | Search only NuGet for "entity" |
          | `pm pip django` | Search only PyPI for "django" |
          | `pm npm @types/node` | Search for scoped packages |

          ## âŒ¨ï¸ Keyboard Shortcuts
          - **Enter** - Copy install command to clipboard
          - **Ctrl+C** - Copy package name
          - **Ctrl+O** - Open package page in browser
          - **Ctrl+U** - Copy package URL

          ## ğŸ¯ Features
          - **Multi-Registry Search**: Search NPM, NuGet, and PyPI simultaneously
          - **Smart Caching**: 10-minute cache for faster repeated searches
          - **Query Variations**: Automatically tries package name variations
          - **Theme Support**: Icons adapt to Windows light/dark theme
          - **Zero Config**: No API keys required, works out of the box
          - **Fast Performance**: Parallel API calls, 0.5-2 second searches

          ## ğŸ“š Documentation
          Full documentation available in the [README](https://github.com/ruslanlap/PowerToysRun-PackageManager#readme)

          ## ğŸ’« Contribute
          Found a bug or have an idea? [Open an issue](https://github.com/ruslanlap/PowerToysRun-PackageManager/issues)

          ---

          Made with â¤ï¸ by [ruslanlap](https://github.com/ruslanlap)
          EOF

          sed -i "s/\$VERSION/$VERSION/g" notes.md

          {
            echo 'NOTES<<EOFMARKER'
            cat notes.md
            echo 'EOFMARKER'
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: PackageManager v${{ steps.version.outputs.VERSION }}
          body: ${{ steps.notes.outputs.NOTES }}
          draft: false
          prerelease: false
          files: release/*
          fail_on_unmatched_files: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    needs: release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Clean up artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: packagemanager-*
          failOnError: false
